# โ ููุฎุต ุงูุชุญุฏูุซุงุช - ุงูุฅุตุฏุงุฑ 2.0.0

## ๐ฏ ุงููุฏู ูู ุงูุชุญุฏูุซ
ุชุญููู ูุธุงู ุฅุฏุงุฑุฉ Token ูู Environment Variables ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุชุ ูุน ุฅุถุงูุฉ ูุธุงู ุฐูู ูุฅุฏุงุฑุฉ ุงูููุฏูููุงุช ุงููุงุดูุฉ ูุฅุนุงุฏุฉ ุฑูุนูุง.

---

## ๐ฆ ุงููููุงุช ุงููุนุฏูุฉ

### 1๏ธโฃ `src/services/db.service.js`
**ุงูุชุบููุฑุงุช:**
- โ ุฅุถุงูุฉ ุฏูุงู ุฅุฏุงุฑุฉ Token:
  - `getGoogleRefreshToken()` - ูุฑุงุกุฉ Token ูู DB
  - `saveGoogleRefreshToken(token)` - ุญูุธ Token ูู DB
  - `updateTokenLastUsed()` - ุชุญุฏูุซ ุขุฎุฑ ุงุณุชุฎุฏุงู
  - `getTokenStatus()` - ุงูุญุตูู ุนูู ุญุงูุฉ Token
  
- โ ุฅุถุงูุฉ ุฏูุงู ุฅุฏุงุฑุฉ ุงูููุฏูููุงุช ุงููุงุดูุฉ:
  - `addFailedUpload(info)` - ุฅุถุงูุฉ ููุฏูู ูุงุดู
  - `getFailedUploads()` - ุฌูุจ ุฌููุน ุงูููุฏูููุงุช ุงููุงุดูุฉ
  - `getFailedUploadsByChatId(chatId)` - ุฌูุจ ููุฏูููุงุช ูุญุงุฏุซุฉ ูุนููุฉ
  - `removeFailedUpload(id)` - ุญุฐู ููุฏูู
  - `incrementFailedUploadAttempts(id)` - ุฒูุงุฏุฉ ุนุฏุฏ ุงููุญุงููุงุช
  - `clearFailedUploads()` - ูุณุญ ุฌููุน ุงูููุฏูููุงุช
  
- โ ุฅุถุงูุฉ ุฏูุงู ุงูุฅุญุตุงุฆูุงุช:
  - `updateUploadStats(success)` - ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงูุฑูุน
  
- โ ููู Token ุชููุงุฆูุงู ูู ENV ุฅูู DB ูู ุฃูู ุชุดุบูู

---

### 2๏ธโฃ `src/services/drive.service.js`
**ุงูุชุบููุฑุงุช:**
- ๐ ูุฑุงุกุฉ Token ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุฏูุงู ูู `process.env`
- โ ุชุญุฏูุซ ุขุฎุฑ ุงุณุชุฎุฏุงู ูุงุฌุญ ุจุนุฏ ูู ุนูููุฉ ุฑูุน
- โ๏ธ ุฑุณุงุฆู ุฎุทุฃ ูุญุณูุฉ ูุน ุชุญุฏูุฏ ููุน ุงูุฎุทุฃ (`isTokenExpired`)

---

### 3๏ธโฃ `src/services/oauth-telegram.service.js`
**ุงูุชุบููุฑุงุช:**
- โ ุญุฐู ุฏุงูุฉ `saveRefreshTokenToEnv()`
- โ ุฅุถุงูุฉ ุฏุงูุฉ `saveRefreshToken()` - ุชุญูุธ ูู DB ููุท
- ๐ ุชุญุฏูุซ `validateRefreshToken()` ููุฑุงุกุฉ ูู DB
- โ ุงุณุชูุฑุงุฏ ุฏูุงู DB ุจุฏูุงู ูู path utils

---

### 4๏ธโฃ `src/bot.js` (ุงูุชุบููุฑุงุช ุงูุฃูุจุฑ)
**ุงูุชุบููุฑุงุช:**

#### ุฃูุงูุฑ ุฌุฏูุฏุฉ:
- `/update_token` - ุชุญุฏูุซ Token (ุจุฏูุงู ูู /refresh_token)
- `/failed_videos` - ุนุฑุถ ุงูููุฏูููุงุช ุงููุงุดูุฉ ูุน ุฃุฒุฑุงุฑ ุชูุงุนููุฉ
- `/token_status` - ุนุฑุถ ุญุงูุฉ Token ูุงูุฅุญุตุงุฆูุงุช

#### ุฃุฒุฑุงุฑ ุชูุงุนููุฉ (Inline Buttons):
- `retry_<id>` - ุฅุนุงุฏุฉ ุฑูุน ููุฏูู ูุงุญุฏ
- `retry_all` - ุฅุนุงุฏุฉ ุฑูุน ุฌููุน ุงูููุฏูููุงุช
- `delete_<id>` - ุญุฐู ููุฏูู ูุงุญุฏ
- `delete_all` - ุญุฐู ุฌููุน ุงูููุฏูููุงุช
- `update_token_now` - ุชุญุฏูุซ Token ุณุฑูุน
- `show_failed` - ุนุฑุถ ุงูููุฏูููุงุช ุงููุงุดูุฉ
- `cancel_retry` - ุฅูุบุงุก ุฅุนุงุฏุฉ ุงูุฑูุน

#### ุฏูุงู ูุณุงุนุฏุฉ ุฌุฏูุฏุฉ:
- `retryUploadVideos(videos, ctx)` - ุฅุนุงุฏุฉ ุฑูุน ูุฌููุนุฉ ูู ุงูููุฏูููุงุช

#### ุชุญุณููุงุช ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:
- ุญูุธ ุงูููุฏูู ูู `failedUploads` ุนูุฏ ูุดู ุงูุฑูุน
- ุญุณุงุจ ูุญูุธ ุญุฌู ุงูููู
- ุฅุฑุณุงู ุฑุงุจุท OAuth ูุจุงุดุฑุฉ ุนูุฏ ุงูุชูุงุก Token
- ุฅุดุนุงุฑุงุช ููุตูุฉ ูููุณุชุฎุฏู

#### ุงุณุชุจุฏุงู:
- โ ุญุฐู ุงุณุชูุฑุงุฏ `upload-queue.service.js`
- โ ุงุณุชุจุฏุงูู ุจุงุณุชูุฑุงุฏ ุฏูุงู DB

---

### 5๏ธโฃ `src/core/recorder.service.js`
**ุงูุชุบููุฑุงุช:**
- ๐ ุงุณุชุฎุฏุงู `getDownloadsPath()` ุจุฏูุงู ูู ุงููุณุงุฑ ุงูุซุงุจุช
- โ ุฏุนู ูุณุงุฑุงุช Docker ุฏููุงููููุงู

---

### 6๏ธโฃ `src/utils/path.util.js` (ุฌุฏูุฏ)
**ุงููุธููุฉ:**
- โ `getDownloadsPath()` - ููุชุดู ุงููุณุงุฑ ุงูุตุญูุญ ุชููุงุฆูุงู:
  - ูุจุญุซ ุนู `DOWNLOADS_PATH` ูู ENV ุฃููุงู
  - ูุจุญุซ ุนู ูุณุงุฑ Docker ุงูุฎุงุต ุจู Coolify
  - ูุณุชุฎุฏู ุงููุณุงุฑ ุงููุญูู ูู fallback
- โ `getEnvPath()` - ูุนูุฏ ูุณุงุฑ .env ุงูุตุญูุญ
- โ `isDockerEnvironment()` - ูุชุญูู ูู ุจูุฆุฉ Docker

---

### 7๏ธโฃ `.env.example`
**ุงูุชุบููุฑุงุช:**
- โ ุฅุถุงูุฉ `GOOGLE_CLIENT_ID`
- โ ุฅุถุงูุฉ `GOOGLE_CLIENT_SECRET`
- โ ุฅุถุงูุฉ `GOOGLE_REFRESH_TOKEN` (ุณูุชู ูููู ุฅูู DB)
- โ ุฅุถุงูุฉ `DOWNLOADS_PATH` (ุงุฎุชูุงุฑู ููู Docker)
- โ ุฅุถุงูุฉ `TIKTOK_COOKIE` (ุงุฎุชูุงุฑู)
- โ ุญุฐู `GOOGLE_CREDENTIALS_PATH`
- โ ุญุฐู ุชุนูููุงุช Cloudinary

---

## ๐๏ธ ุงููููุงุช ุงููุญุฐููุฉ

### `src/services/upload-queue.service.js`
**ุงูุณุจุจ:** ุชู ุงุณุชุจุฏุงูู ุจูุธุงู DB ุงููุฏูุฌ ูู `db.service.js`

---

## ๐ ุงููููุงุช ุงูุฌุฏูุฏุฉ

### 1๏ธโฃ `README.md`
- ุฏููู ุดุงูู ุจุงูุนุฑุจูุฉ
- ุดุฑุญ ุฌููุน ุงูุฃูุงูุฑ ูุงููููุฒุงุช
- ุณููุงุฑูููุงุช ุงุณุชุฎุฏุงู ูุงููุฉ
- ุฏููู ุงููุดุฑ ุนูู Coolify
- ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### 2๏ธโฃ `CHANGELOG.md`
- ุณุฌู ุจุฌููุน ุงูุชุบููุฑุงุช
- ููุงุฑูุฉ ุจูู ุงูุฅุตุฏุงุฑุงุช
- ุฎุทุฉ ุงูุฅุตุฏุงุฑุงุช ุงููุงุฏูุฉ

### 3๏ธโฃ `DEPLOYMENT_SUMMARY.md` (ูุฐุง ุงูููู)
- ููุฎุต ุดุงูู ููู ุงูุชุนุฏููุงุช

---

## ๐ ูููู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฌุฏูุฏ

### ูุจู:
```json
{
  "monitoredUsers": [...]
}
```

### ุจุนุฏ:
```json
{
  "monitoredUsers": [...],
  "settings": {
    "googleRefreshToken": "1//03xxx...",
    "tokenLastUpdated": "2025-12-04T10:30:00Z",
    "tokenLastUsed": "2025-12-04T11:00:00Z"
  },
  "failedUploads": [
    {
      "id": "username_timestamp",
      "username": "sifouxgaming",
      "filepath": "/path/to/video.mp4",
      "chatId": 123456,
      "failedAt": "2025-12-04T10:00:00Z",
      "error": "invalid_grant",
      "fileSize": "6.35 MB",
      "attempts": 1
    }
  ],
  "stats": {
    "totalUploads": 45,
    "successfulUploads": 42,
    "failedUploads": 3
  }
}
```

---

## ๐ ุฎุทูุงุช ุงููุดุฑ ุนูู Coolify

### 1๏ธโฃ ุชุญุฏูุซ Environment Variables
```bash
# ุฅุฒุงูุฉ (ุฅุฐุง ูุงู ููุฌูุฏุงู):
GOOGLE_CREDENTIALS_PATH=xxx

# ุงูุชุฃูุฏ ูู ูุฌูุฏ:
TELEGRAM_BOT_TOKEN=xxx
GOOGLE_CLIENT_ID=xxx
GOOGLE_CLIENT_SECRET=xxx
GOOGLE_DRIVE_FOLDER_ID=xxx

# ุฅุฐุง ูุงู ูุฏูู Token ูุฏูู (ุณูุชู ูููู ุชููุงุฆูุงู):
GOOGLE_REFRESH_TOKEN=1//03xxx...

# ุงุฎุชูุงุฑู:
TIKTOK_COOKIE=xxx
```

### 2๏ธโฃ Push ุงูููุฏ ุงูุฌุฏูุฏ
```bash
git add .
git commit -m "v2.0.0: ูุธุงู Token ููุงุฆูุฉ ุงูุชุธุงุฑ ุฐููุฉ"
git push origin main
```

### 3๏ธโฃ Deploy ูู Coolify
- Coolify ุณููุชุดู ุงูุชุญุฏูุซุงุช ุชููุงุฆูุงู
- ุณูููู ุจุชุซุจูุช Dependencies
- ุนูุฏ ุฃูู ุชุดุบููุ ุณูููู Token ูู ENV ุฅูู DB

### 4๏ธโฃ ุงูุชุญูู ูู ุงููุฌุงุญ
```bash
# ูู Coolify Logs:
[DB] ุชู ุฅุนุฏุงุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ.
[DB] โ ุชู ููู GOOGLE_REFRESH_TOKEN ูู ENV ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
ุงูุจูุช ูุฎุฏูุฉ ุงููุฑุงูุจุฉ ูุนููุงู ุงูุขู...
```

---

## โ ุงุฎุชุจุงุฑ ุงููููุฒุงุช ุงูุฌุฏูุฏุฉ

### Test 1: ุชุญุฏูุซ Token
```
1. ุฃุฑุณู /update_token ููุจูุช
2. ุงูุชุญ ุงูุฑุงุจุท ูู ุงููุชุตูุญ
3. ุณุฌู ุงูุฏุฎูู
4. ุงูุณุฎ ุงูููุฏ
5. ุฃุฑุณูู ููุจูุช
6. ุชุญูู ูู ุงูุฑุณุงูุฉ: "โ ุชู ุชุญุฏูุซ Token ุจูุฌุงุญ!"
```

### Test 2: ุนุฑุถ ุงูููุฏูููุงุช ุงููุงุดูุฉ
```
1. ุฃุฑุณู /failed_videos
2. ูุฌุจ ุฃู ุชุฑู ุงูููุฏูู ุงูุนุงูู ุญุงููุงู:
   benz.marketing_2025-12-03T20-14-38.mp4
```

### Test 3: ุฅุนุงุฏุฉ ุฑูุน ุงูููุฏูู
```
1. ุจุนุฏ ุชุญุฏูุซ Token
2. ุงุถุบุท "ุฅุนุงุฏุฉ ุฑูุน ุงููู"
3. ุงูุชุธุฑ ุญุชู ููุชูู ุงูุฑูุน
4. ุชุญูู ูู ุฑุงุจุท Google Drive
```

### Test 4: ุญุงูุฉ Token
```
1. ุฃุฑุณู /token_status
2. ูุฌุจ ุฃู ุชุฑู:
   - ุงูุญุงูุฉ: โ ูุดุท
   - ุขุฎุฑ ุชุญุฏูุซ
   - ุงูุฅุญุตุงุฆูุงุช
```

---

## ๐ ูุดุงูู ูุญุชููุฉ ูุญููููุง

### ุงููุดููุฉ 1: "GOOGLE_REFRESH_TOKEN ุบูุฑ ููุฌูุฏ"
**ุงูุญู:** 
- ุงุณุชุฎุฏู `/update_token` ูุฅุฏุฎุงู Token ุฌุฏูุฏ
- ุฃู ุฃุถูู ูุฏููุงู ูู Coolify Environment Variables (ุณูููู ุชููุงุฆูุงู)

### ุงููุดููุฉ 2: ุงูููุฏูู ุงูุนุงูู ุบูุฑ ุธุงูุฑ ูู `/failed_videos`
**ุงูุญู:**
- ุงูููุฏูู ููุฌูุฏ ููุท ูู ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ุงููุฏููุฉ (memory)
- ุจุนุฏ ุฅุนุงุฏุฉ ุงูุชุดุบููุ ุงุณุชุฎุฏู `/update_token` ุซู ุณุฌู ููุฏูู ุฌุฏูุฏ ููุงุฎุชุจุงุฑ

### ุงููุดููุฉ 3: ุฎุทุฃ ูู ูุฑุงุกุฉ DB
**ุงูุญู:**
```bash
# ุชุฃูุฏ ูู ูุฌูุฏ db.json ูุตูุงุญูุงุชู
ls -la db.json
chmod 644 db.json
```

---

## ๐ ุงูุฅุญุตุงุฆูุงุช

| ุงููุคุดุฑ | ุงููููุฉ |
|-------|--------|
| ูููุงุช ูุนุฏูุฉ | 7 |
| ูููุงุช ุฌุฏูุฏุฉ | 4 |
| ูููุงุช ูุญุฐููุฉ | 1 |
| ุฃุณุทุฑ ูุถุงูุฉ | ~850 |
| ุฃุณุทุฑ ูุญุฐููุฉ | ~200 |
| ุฏูุงู ุฌุฏูุฏุฉ | 15+ |
| ุฃูุงูุฑ ุฌุฏูุฏุฉ | 3 |

---

## ๐ฏ ุงูุฎูุงุตุฉ

### โ ูุง ุชู ุฅูุฌุงุฒู:
1. ูุธุงู Token ุฐูู ูู DB
2. ูุงุฆูุฉ ุงูุชุธุงุฑ ููููุฏูููุงุช ุงููุงุดูุฉ
3. ุฃูุงูุฑ ูุฃุฒุฑุงุฑ ุชูุงุนููุฉ ุฌุฏูุฏุฉ
4. ุฏุนู ูุญุณูู ูู Docker/Coolify
5. ุฅุญุตุงุฆูุงุช ุดุงููุฉ
6. ุชูุซูู ูุงูู

### ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ:
1. Deploy ุนูู Coolify
2. ุงุฎุชุจุงุฑ `/update_token`
3. ุงุฎุชุจุงุฑ ุฅุนุงุฏุฉ ุฑูุน ุงูููุฏูููุงุช
4. ูุฑุงูุจุฉ ุงูุฃุฎุทุงุก ูุงูุฅุญุตุงุฆูุงุช

---

**ุชู ุฅูุฌุงุฒ ุงูุชุญุฏูุซ ุจูุฌุงุญ! ๐**

ุชุงุฑูุฎ: 4 ุฏูุณูุจุฑ 2025
ุงูุฅุตุฏุงุฑ: 2.0.0
