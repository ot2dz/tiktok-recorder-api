# ๐ง ุฅุตูุงุญ ูุดููุฉ invalid_grant ุจุฏูู Restart

## โ ุงููุดููุฉ ุงูุณุงุจูุฉ:

```
1. ุชุญุฏูุซ Token ุนุจุฑ /update_token
2. Token ููุญูุธ ูู DB โ
3. ููู Drive Client ุงููุฏูู ูุญููุธ ูู ุงูุฐุงูุฑุฉ
4. ุนูุฏ ุฅุนุงุฏุฉ ุงูุฑูุน โ invalid_grant โ
5. ุงูุญู ูุงู: Restart ุงูุจูุช
6. ููู Restart ูุญุฐู ุงูููุฏูููุงุช ูู ุงูุณูุฑูุฑ! ๐ฅ
```

---

## โ ุงูุญู ุงูุงุญุชุฑุงูู ุงูุฌุฏูุฏ:

### **ุฅุถุงูุฉ ุฏุงูุฉ `resetDriveClient()`**

#### ููู ูุนููุ
```javascript
// ูุจู:
let drive = null; // ูุญููุธ ูู ุงูุฐุงูุฑุฉ ูุน Token ุงููุฏูู

// ุจุนุฏ ุชุญุฏูุซ Token:
resetDriveClient(); // ูุนูุฏ ุชุนููู drive ุฅูู null

// ุนูุฏ ุฃูู ุงุณุชุฎุฏุงู:
initializeDrive(); // ููุดุฆ client ุฌุฏูุฏ ุจู Token ุงูุฌุฏูุฏ ูู DB
```

---

## ๐ ุงูุชุฏูู ุงูุฌุฏูุฏ:

```
1. ุงููุณุชุฎุฏู: /update_token
   โ
2. ุงูุจูุช: ูุฑุณู ุฑุงุจุท OAuth
   โ
3. ุงููุณุชุฎุฏู: ูุฑุณู ุงูููุฏ
   โ
4. ุงูุจูุช: exchangeCodeForToken()
   โ
5. ุงูุจูุช: saveRefreshToken()
   โโ> ูุญูุธ ูู DB โ
   โโ> resetDriveClient() ๐ (ุฌุฏูุฏ!)
   โ
6. ุงููุณุชุฎุฏู: ูุฎุชุงุฑ "ุฅุนุงุฏุฉ ุฑูุน"
   โ
7. ุงูุจูุช: retryUploadVideos()
   โโ> uploadVideoToDrive()
   โ   โโ> initializeDrive()
   โ       โโ> ููุฑุฃ Token ุงูุฌุฏูุฏ ูู DB โ
   โโ> ุฑูุน ูุงุฌุญ! ๐
```

---

## ๐ ุงูุชุนุฏููุงุช ุงูููููุฐุฉ:

### 1๏ธโฃ `src/services/drive.service.js`

```javascript
// โ ุฅุถุงูุฉ ุฏุงูุฉ ุฌุฏูุฏุฉ:
function resetDriveClient() {
    drive = null;
    console.log('[Google Drive] ๐ ุชู ุฅุนุงุฏุฉ ุชุนููู Drive Client');
}

// โ ุชุตุฏูุฑูุง:
export {
    uploadVideoToDrive,
    resetDriveClient  // ุฌุฏูุฏ
};
```

---

### 2๏ธโฃ `src/services/oauth-telegram.service.js`

```javascript
async function saveRefreshToken(refreshToken) {
    try {
        await saveGoogleRefreshToken(refreshToken);
        console.log('[OAuth] โ ุชู ุญูุธ Token');
        
        // โ ุฌุฏูุฏ: ุฅุนุงุฏุฉ ุชุนููู Drive ููุฑุงู
        const { resetDriveClient } = await import('./drive.service.js');
        resetDriveClient();
        
        console.log('[OAuth] ๐ Drive Client ุฌุงูุฒ ูุน Token ุงูุฌุฏูุฏ');
    } catch (error) {
        console.error('[OAuth] โ ูุดู:', error.message);
        throw error;
    }
}
```

---

## ๐งช ููููุฉ ุงูุงุฎุชุจุงุฑ:

### ุงูุณููุงุฑูู ุงููุงูู:

```bash
# 1. ุชุฃูุฏ ูู ูุฌูุฏ ููุฏูู ูุงุดู
/failed_videos
# ูุฌุจ ุฃู ุชุฑู: benz.marketing_2025-12-06T21-30-39.mp4

# 2. ุฌุฏุฏ Token
/update_token
# ุงูุชุญ ุงูุฑุงุจุทุ ุณุฌู ุงูุฏุฎููุ ุงูุณุฎ ุงูููุฏ

# 3. ุฃุฑุณู ุงูููุฏ
4/1ATX87lPLY8IKFzpVQC0hoKm0fpYfVxqMR0NxIxYcndk9kIsuOZ30xfNgTRY

# 4. ูุฌุจ ุฃู ุชุฑู:
โ ุชู ุชุญุฏูุซ Token ุจูุฌุงุญ!
๐ ูู ุชุฑูุฏ ุฅุนุงุฏุฉ ุฑูุน ุงูููุฏูููุงุช ุงููุงุดูุฉ?

# 5. ุงุถุบุท "ูุนู"

# 6. ุงููุชูุฌุฉ ุงููุชููุนุฉ:
๐ ุฌุงุฑู ุฑูุน: benz.marketing_2025-12-06T21-30-39.mp4...
โ ุชู ุฑูุน ุงูููุฏูู ุจูุฌุงุญ! โ ุจุฏูู invalid_grant!
```

---

## ๐ ุงูููุงุฑูุฉ:

| ุงูููุฒุฉ | ูุจู | ุจุนุฏ |
|-------|-----|-----|
| **ุชุญุฏูุซ Token** | โ | โ |
| **ุงุณุชุฎุฏุงู Token ุงูุฌุฏูุฏ** | โ ูุญุชุงุฌ Restart | โ ููุฑู |
| **ุงูููุฏูููุงุช** | โ ุชูุญุฐู ุนูุฏ Restart | โ ูุญููุธุฉ |
| **ุงูููุช** | ~30 ุซุงููุฉ (Restart) | ~0 ุซุงููุฉ |
| **ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู** | ุณูุฆุฉ ๐ | ููุชุงุฒุฉ ๐ |

---

## ๐ฏ ุงูููุงุฆุฏ:

1. โ **ูุง ุญุงุฌุฉ ูู Restart ุฃุจุฏุงู**
2. โ **ุงูููุฏูููุงุช ูุญููุธุฉ ูู ุงูุณูุฑูุฑ**
3. โ **ุฅุนุงุฏุฉ ุฑูุน ููุฑูุฉ ุจุนุฏ ุชุญุฏูุซ Token**
4. โ **ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุณูุณุฉ**
5. โ **ูุง downtime**

---

## ๐ Logs ุงููุชููุนุฉ:

```bash
# ุนูุฏ ุชุญุฏูุซ Token:
[OAuth Telegram] โ ุชู ุญูุธ Refresh Token ุงูุฌุฏูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
[Google Drive] ๐ ุชู ุฅุนุงุฏุฉ ุชุนููู Drive Client - ุณููุณุชุฎุฏู Token ุงูุฌุฏูุฏ ูู ุงููุฑุฉ ุงููุงุฏูุฉ
[OAuth Telegram] ๐ ุชู ุฅุนุงุฏุฉ ุชุนููู Drive Client - ุฌุงูุฒ ููุงุณุชุฎุฏุงู ูุน Token ุงูุฌุฏูุฏ

# ุนูุฏ ุฅุนุงุฏุฉ ุงูุฑูุน:
[Retry] ๐ ุฌุงุฑู ุฑูุน: benz.marketing_2025-12-06T21-30-39.mp4...
[Google Drive] โ ุชู ุชููุฆุฉ Google Drive API ุจูุฌุงุญ (Token ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช).
[Google Drive] ๐ค ุจุฏุก ุฑูุน ุงูููู: /var/lib/.../benz.marketing_2025-12-06T21-30-39.mp4
[Google Drive] ๐ ุญุฌู ุงูููู: 602.68 MB
[Google Drive] โ ุชู ุงูุฑูุน ุจูุฌุงุญ! ูุนุฑู ุงูููู: 1xyz...
[Retry] โ ุชู ุฑูุน ุงูููู ุจูุฌุงุญ
```

---

## โก Deploy ุนูู Coolify:

```bash
# 1. Push ุงูุชุนุฏููุงุช
git add .
git commit -m "fix: ุฅุตูุงุญ invalid_grant ุจุฏูู restart"
git push origin main

# 2. Coolify ุณูููู ุจู Deploy ุชููุงุฆูุงู

# 3. ุงุฎุชุจุฑ:
/update_token โ ุฃุฏุฎู ุงูููุฏ
ุงุถุบุท "ุฅุนุงุฏุฉ ุฑูุน"
โ ูุฌุจ ุฃู ูุนูู ูุจุงุดุฑุฉ!
```

---

## ๐ ุงูุฎูุงุตุฉ:

**ุงููุดููุฉ:** Drive Client ูุญููุธ ูู ุงูุฐุงูุฑุฉ ุจู Token ูุฏูู
**ุงูุญู:** ุฅุนุงุฏุฉ ุชุนููู ุชููุงุฆูุฉ ุนูุฏ ุชุญุฏูุซ Token
**ุงููุชูุฌุฉ:** ุฑูุน ููุฑู ุจุฏูู Restart ูุจุฏูู ููุฏุงู ุงูููุฏูููุงุช!

---

**ุชุงุฑูุฎ ุงูุชุญุฏูุซ:** 7 ุฏูุณูุจุฑ 2025
**ุงูุฅุตุฏุงุฑ:** 2.0.1
