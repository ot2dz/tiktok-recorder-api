const { Telegraf, Markup } = require('telegraf');
const { message } = require('telegraf/filters');
const fs = require('fs');
require('dotenv').config();

const tiktokService = require('./services/tiktok.service');
const recorderService = require('./core/recorder.service');
const cloudinaryService = require('./services/cloudinary.service');

if (!process.env.TELEGRAM_BOT_TOKEN) {
    console.error('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ TELEGRAM_BOT_TOKEN ÙÙŠ Ù…Ù„Ù .env');
    process.exit(1);
}

const bot = new Telegraf(process.env.TELEGRAM_BOT_TOKEN);

const userState = {};
const activeRecordings = {}; // Ù„ØªØªØ¨Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©

const CHECK_STATUS_BTN = 'ðŸ” ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø«';
const RECORD_LIVE_BTN = 'ðŸ”´ Ø¨Ø¯Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø¨Ø«';

const mainKeyboard = Markup.keyboard([
    [CHECK_STATUS_BTN],
    [RECORD_LIVE_BTN]
]).resize();

bot.start((ctx) => {
    ctx.reply(
        'Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø§Ø®ØªØ± Ø£Ø­Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø¨Ø¯Ø¡.',
        mainKeyboard
    );
});

bot.hears(CHECK_STATUS_BTN, (ctx) => {
    userState[ctx.chat.id] = 'check_status';
    ctx.reply('Ø­Ø³Ù†Ø§Ù‹ØŒ Ø£Ø±Ø³Ù„ Ø§Ù„Ø¢Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ù‰ ØªÙŠÙƒ ØªÙˆÙƒ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ ÙØ­ØµÙ‡.');
});

bot.hears(RECORD_LIVE_BTN, (ctx) => {
    userState[ctx.chat.id] = 'record_live';
    ctx.reply('Ø­Ø³Ù†Ø§Ù‹ØŒ Ø£Ø±Ø³Ù„ Ø§Ù„Ø¢Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ù‰ ØªÙŠÙƒ ØªÙˆÙƒ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø¨Ø¯Ø¡ ØªØ³Ø¬ÙŠÙ„Ù‡.');
});

// Ù…Ø¹Ø§Ù„Ø¬ Ø²Ø± Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„
bot.action(/stop_record_(.+)/, (ctx) => {
    const username = ctx.match[1];
    const recording = activeRecordings[username];

    if (recording && recording.controller) {
        ctx.answerCbQuery(`Ø¬Ø§Ø±ÙŠ Ø¥ÙŠÙ‚Ø§Ù ØªØ³Ø¬ÙŠÙ„ ${username}...`);
        recording.controller.abort(); // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù
        delete activeRecordings[username];
        ctx.editMessageText(`ØªÙ… Ø·Ù„Ø¨ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ${username}. Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø³Ø¬Ù„ Ù‚Ø±ÙŠØ¨Ù‹Ø§.`);
    } else {
        ctx.answerCbQuery('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù…Ù„ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø·Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….');
    }
});

bot.on(message('text'), async (ctx) => {
    const chatId = ctx.chat.id;
    const currentState = userState[chatId];
    const username = ctx.message.text.trim().replace('@', '');

    if (!currentState) {
        ctx.reply('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø£Ø­Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹.', mainKeyboard);
        return;
    }

    delete userState[chatId];

    switch (currentState) {
        case 'check_status':
            await handleCheckStatus(ctx, username);
            break;
        case 'record_live':
            await handleRecordLive(ctx, username);
            break;
    }
});

async function handleCheckStatus(ctx, username) {
    await ctx.reply(`Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${username}"...`);
    try {
        const roomId = await tiktokService.getRoomId(username);
        if (!roomId || !(await tiktokService.isUserLive(roomId))) {
            await ctx.reply(`âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${username}" Ù„ÙŠØ³ ÙÙŠ Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± Ø­Ø§Ù„ÙŠØ§Ù‹.`);
            return;
        }
        await ctx.reply(`âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${username}" ÙÙŠ Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± Ø§Ù„Ø¢Ù†!`);
    } catch (error) {
        console.error(error);
        await ctx.reply('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….');
    }
}

async function handleRecordLive(ctx, username) {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØ³Ø¬ÙŠÙ„ Ø¬Ø§Ø±ÙŠ Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if (activeRecordings[username]) {
        await ctx.reply(`ÙŠÙˆØ¬Ø¯ Ø¨Ø§Ù„ÙØ¹Ù„ Ø¹Ù…Ù„ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø¬Ø§Ø±ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ${username}.`);
        return;
    }

    const checkingMsg = await ctx.reply(`Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© ${username} Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...`);
    
    try {
        // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±
        const roomId = await tiktokService.getRoomId(username);
        if (!roomId || !(await tiktokService.isUserLive(roomId))) {
            await bot.telegram.editMessageText(ctx.chat.id, checkingMsg.message_id, undefined, `âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„. Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${username}" Ù„ÙŠØ³ ÙÙŠ Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± Ø­Ø§Ù„ÙŠØ§Ù‹.`);
            return;
        }

        // 2. Ø¬Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø«
        const streamUrl = await tiktokService.getLiveStreamUrl(roomId);
        if (!streamUrl) {
            await bot.telegram.editMessageText(ctx.chat.id, checkingMsg.message_id, undefined, 'Ø­Ø¯Ø« Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø«.');
            return;
        }

        const controller = new AbortController();
        const stopButton = Markup.inlineKeyboard([
            Markup.button.callback('â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„', `stop_record_${username}`)
        ]);

        const recordingMsg = await bot.telegram.editMessageText(ctx.chat.id, checkingMsg.message_id, undefined, `ðŸ”´ Ø¨Ø¯Ø£ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø« Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ${username}...`, stopButton);
        
        // Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        activeRecordings[username] = { controller, messageId: recordingMsg.message_id };

        // 3. Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… await Ù‡Ù†Ø§ Ù„ØªØ¬Ù†Ø¨ Ø­Ø¬Ø¨ Ø§Ù„Ø¨ÙˆØª)
        recorderService.recordLiveStream(streamUrl, username, controller.signal)
            .then(async (finalMp4Path) => {
                try {
                    // 1. Ø¥Ø¹Ù„Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø§Ù„Ø±ÙØ¹
                    await bot.telegram.editMessageText(ctx.chat.id, recordingMsg.message_id, undefined, `âœ… Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªØ³Ø¬ÙŠÙ„. Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¥Ù„Ù‰ ØªÙ„ÙŠØ¬Ø±Ø§Ù…...`);
                    
                    // 2. Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¥Ù„Ù‰ ØªÙ„ÙŠØ¬Ø±Ø§Ù…
                    await ctx.replyWithVideo({ source: finalMp4Path });

                    // 3. Ø¥Ø¹Ù„Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø§Ù„Ø±ÙØ¹ Ø¥Ù„Ù‰ Cloudinary
                    await ctx.reply('ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¥Ù„Ù‰ ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­. Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¢Ù† Ø£Ø±Ø´ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¹Ù„Ù‰ Cloudinary...');
                    
                    // 4. Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¥Ù„Ù‰ Cloudinary
                    const cloudinaryResult = await cloudinaryService.uploadVideo(finalMp4Path, username);

                    // 5. Ø¥Ø±Ø³Ø§Ù„ ØªØ£ÙƒÙŠØ¯ ÙˆØ±Ø§Ø¨Ø· Cloudinary
                    await ctx.reply(`â˜ï¸ ØªÙ…Øª Ø£Ø±Ø´ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­!\nØ§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø§Ø¦Ù…: ${cloudinaryResult.secure_url}`);

                } catch (uploadError) {
                    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø±ÙØ¹
                    console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹ (ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø£Ùˆ Cloudinary):", uploadError);
                    await ctx.reply('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„Ù‡.');
                } finally {
                    // 6. Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙŠ ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª (Ù†Ø¬Ø§Ø­ Ø£Ùˆ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹)
                    // Ø·Ø§Ù„Ù…Ø§ Ø£Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù†ÙØ³Ù‡ Ù‚Ø¯ Ù†Ø¬Ø­
                    console.log(`[FS] Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ù„ÙŠ: ${finalMp4Path}`);
                    fs.unlinkSync(finalMp4Path);
                }
            })
            .catch(async (error) => {
                // 5. ÙÙŠ Ø­Ø§Ù„Ø© Ø­Ø¯ÙˆØ« Ø®Ø·Ø£
                console.error(`Ø®Ø·Ø£ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù„Ù€ ${username}:`, error);
                await bot.telegram.editMessageText(ctx.chat.id, recordingMsg.message_id, undefined, `Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ ${username}.`);
            })
            .finally(() => {
                // 6. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø§Ù„Ù†ØªÙŠØ¬Ø©
                delete activeRecordings[username];
            });

    } catch (error) {
        console.error(error);
        await bot.telegram.editMessageText(ctx.chat.id, checkingMsg.message_id, undefined, 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¹Ø§Ù… Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„.');
    }
}

bot.launch();
console.log('Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†...');

process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));